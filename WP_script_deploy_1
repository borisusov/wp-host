#/bin/bash

#Script to set up ready to deploy Ubuntu host with WordPress



#на хості робимо папочку проекту

#треба зробити первірку чи вона (директорія) існує тоді скіпнути цей степ
#так само і гіт (як ???)


 mkdir wp-host
 cd wp-host/
 git init
# git add .
# git status
#make file for check ports forwarding
# touch ports.txt
 

#вагрантом треба зробити в.м. з убунтіком 
v box list
vagrant init xplore/ubuntu-14.04
curl -O -L  https://vagrantcloud.com/xplore/boxes/ubuntu-14.04/versions/0.3.2/providers/virtualbox.box
grant box add --name xplore/ubuntu-14.04 virtualbox.box
# vagrant box list
vagrant up


cd solutions
cd wp-host/
#закинути порти 
# vim Vagrantfile 

#git add ports.txt 
git commit -m "list ports forwarding  "
git push
 
git remote add origin git@github.com:borisusov/wp-host.git
# git push
# pull origin master
# git branch --set-upstream-to=origin/master master


#SA section

openssl genrsa -aes256 -out ca-key.pem 4096
openssl req -new -x509 -days 365 -key ca-key.pem -sha256 -out ca.pem
#? вставити дані для сертифіката
openssl genrsa -out server-key.pem 4096
openssl req -subj "/CN=$HOST" -sha256 -new -key server-key.pem -out server.csr


#Set the daemon key’s extended usage attributes to be used only for server authentication
echo subjectAltName = DNS:$HOST,IP:10.10.10.20,IP:127.0.0.1 >> extfile.cnf
echo extendedKeyUsage = serverAuth >> extfile.cnf

#generate the signed certificate
openssl x509 -req -days 365 -sha256 -in server.csr -CA ca.pem -CAkey ca-key.pem \
  -CAcreateserial -out server-cert.pem -extfile extfile.cnf

#remove unusual data
rm -v client.csr server.csr

#protect your keys
chmod -v 0400 ca-key.pem key.pem server-key.pem

chmod -v 0444 ca.pem server-cert.pem cert.pem


#you can make the Docker daemon only accept connections from clients providing a certificate #trusted by your CA


#######dockerd --tlsverify --tlscacert=ca.pem --tlscert=server-cert.pem --tlskey=server-key.pem \
######!!!!!!!!! підставляемо!!!!!!!!!  -H=0.0.0.0:2376


#WordPress section

#описати де взяти і як підставити параметри -u -(user sql as a root) -p (sql root pass)

mysql -u root -p

   
cd /etc/mysql/

#cat debian.cnf 
#cd /root
mysql -u debian-sys-maint {це юзер!!!} -p(пароль цього юзера!!)

#стягуем вордпрес
wget http://wordpress.org/latest.tar.gz

#розпаковуем
tar xzvf latest.tar.gz

#php section
apt-get update
apt-get install php5-gd libssh2-php

#cd ~/wordpress

#встановлюемо вордпрес

cp wp-config-sample.php wp-config.php
curl -s https://api.wordpress.org/secret-key/1.1/salt/
apt-get install curl
curl -s https://api.wordpress.org/secret-key/1.1/salt/
apt-get install vim

#? як це реалізувати?
vim wp-config.php

rsync -avP ~/wordpress/ /var/www/html/

mkdir /var/www/html/wp-content/uploads
chown -R :www-data /var/www/html/wp-content/uploads

cd /etc/cd apache2/sites-enabled/

#vim 000-default.conf 
systemctl service apache2 restart 
 
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout mysitename.key -out mysitename.crt
cd /etc/apache2/
# ???  vim apache2.conf 

mv /root/mysitename.* /etc/ssl/private/

#sudo a2enmod ssl
#reboot
#history >/vagrant/setup-history.txt




